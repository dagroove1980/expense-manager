<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categories - Wealth OS</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-icon">üí∞</span>
                <span class="logo-text">Wealth OS</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="expenses.html" class="nav-link">Expenses</a>
                <a href="categories.html" class="nav-link active">Categories</a>
            </div>
        </div>
    </nav>

    <main class="page-content">
        <div class="page-header">
            <h1>Categories</h1>
            <p class="page-subtitle">Organize your expenses with custom categories</p>
        </div>

        <div class="action-bar">
            <button class="btn btn-primary" onclick="openAddCategoryModal()">+ Add Category</button>
        </div>

        <div class="content-wrapper">
            <div id="categories-container" class="expenses-grid">
                <!-- Categories will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Add/Edit Category Modal -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="category-modal-title">Add Category</h2>
                <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
            </div>
            <form id="category-form" onsubmit="saveCategory(event)">
                <input type="hidden" id="category-id">
                <div class="form-group">
                    <label for="category-name">Category Name *</label>
                    <input type="text" id="category-name" required>
                </div>
                <div class="form-group">
                    <label for="category-icon">Icon (emoji)</label>
                    <input type="text" id="category-icon" placeholder="üí∞" maxlength="2">
                </div>
                <div class="form-group">
                    <label for="category-color">Color</label>
                    <input type="color" id="category-color" value="#6366f1">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Category</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alert-container" class="alert-container"></div>
    <script src="config.js"></script>
    <script src="supabase.js"></script>
    <script src="app.js"></script>
    <script>
        async function loadCategories() {
            await refreshCache();
            const categories = getCategories();
            renderCategories(categories);
        }

        function renderCategories(categories) {
            const container = document.getElementById('categories-container');
            if (!container) return;

            if (categories.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üè∑Ô∏è</div>
                        <h3>No categories yet</h3>
                        <p>Click "Add Category" to create your first category!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = categories.map(category => {
                return `
                    <div class="expense-card">
                        <div class="expense-header">
                            <div>
                                <div class="expense-description" style="font-size: 1.5rem;">
                                    <span style="font-size: 2rem;">${category.icon}</span>
                                    ${escapeHtml(category.name)}
                                </div>
                                <div style="margin-top: 0.5rem;">
                                    <span class="expense-category" style="background: ${category.color}20; color: ${category.color};">
                                        Color Preview
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="expense-actions">
                            <button onclick="editCategory('${category.id}')" style="flex: 1;">Edit</button>
                            <button onclick="deleteCategory('${category.id}')" class="btn-danger" style="flex: 1;">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAddCategoryModal() {
            document.getElementById('category-modal').classList.add('active');
            document.getElementById('category-modal-title').textContent = 'Add Category';
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            document.getElementById('category-color').value = '#6366f1';
            document.getElementById('category-icon').value = 'üí∞';
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').classList.remove('active');
        }

        function editCategory(id) {
            const categories = getCategories();
            const category = categories.find(c => c.id === id);
            if (!category) return;

            document.getElementById('category-modal').classList.add('active');
            document.getElementById('category-modal-title').textContent = 'Edit Category';
            document.getElementById('category-id').value = category.id;
            document.getElementById('category-name').value = category.name;
            document.getElementById('category-icon').value = category.icon || 'üí∞';
            document.getElementById('category-color').value = category.color || '#6366f1';
        }

        async function saveCategory(event) {
            event.preventDefault();
            
            const id = document.getElementById('category-id').value;
            const name = document.getElementById('category-name').value.trim();
            const icon = document.getElementById('category-icon').value.trim() || 'üí∞';
            const color = document.getElementById('category-color').value;

            const categories = getCategories();
            
            if (id) {
                // Edit existing
                const index = categories.findIndex(c => c.id === id);
                if (index !== -1) {
                    categories[index] = {
                        ...categories[index],
                        name,
                        icon,
                        color
                    };
                    showAlert('success', 'Category Updated', 'Your category has been updated successfully.');
                }
            } else {
                // Check for duplicate name
                if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                    showAlert('error', 'Duplicate Category', 'A category with this name already exists.');
                    return;
                }
                
                // Add new
                const newCategory = {
                    id: generateId(),
                    name,
                    icon,
                    color
                };
                categories.push(newCategory);
                showAlert('success', 'Category Added', 'Your category has been added successfully.');
            }

            await saveCategories(categories);
            closeCategoryModal();
            loadCategories();
        }

        async function deleteCategory(id) {
            // Check if category is used in expenses
            const expenses = getExpenses();
            const usedInExpenses = expenses.some(e => e.categoryId === id);
            
            if (usedInExpenses) {
                if (!confirm('This category is used in some expenses. Deleting it will remove the category from those expenses. Continue?')) {
                    return;
                }
                // Remove category from expenses
                const updatedExpenses = expenses.map(e => 
                    e.categoryId === id ? { ...e, categoryId: null } : e
                );
                await saveExpenses(updatedExpenses);
            } else {
                if (!confirm('Are you sure you want to delete this category?')) return;
            }

            const categories = getCategories().filter(c => c.id !== id);
            await saveCategories(categories);
            showAlert('success', 'Category Deleted', 'The category has been deleted.');
            loadCategories();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.supabaseReady) {
                loadCategories();
            } else {
                setTimeout(loadCategories, 1000);
            }
        });

        // Make functions globally available
        window.loadCategories = loadCategories;
        window.openAddCategoryModal = openAddCategoryModal;
        window.closeCategoryModal = closeCategoryModal;
        window.editCategory = editCategory;
        window.deleteCategory = deleteCategory;
    </script>
</body>
</html>

